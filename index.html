<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini Lens ‚Äî PDF + PasseiDireto + ChatGPT</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    :root {
      --bg1:#ffe4e6; --bg2:#fdf2f8; --fg:#3f3f46; --muted:#6b7280;
      --card:#ffffffcc; --stroke:#fbcfe8; --accent:#ec4899; --accent-2:#f472b6;
      --shadow: 0 10px 30px rgba(236,72,153,0.20);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin:0; font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica Neue, Arial;
      background: linear-gradient(180deg, var(--bg1), var(--bg2)); color: var(--fg); }
    .wrap{ max-width:1000px; margin:0 auto; padding:20px; }

    /* Header */
    .hero { position: relative; overflow: hidden; border-radius: 22px; padding: 22px; background: linear-gradient(135deg, #fb7185 0%, #ec4899 35%, #e879f9 100%); color: #fff; box-shadow: var(--shadow); }
    .hero .brand { display:flex; align-items:center; gap:12px; justify-content:space-between; }
    .logo { width:40px; height:40px; border-radius:12px; background:#ffffff22; display:grid; place-items:center; font-weight:700; }
    .title { font-size: clamp(24px, 4vw, 36px); margin:6px 0 4px; font-weight:700; }
    .subtitle { opacity: .95; font-size: clamp(12px, 2vw, 14px); }

    /* Card */
    .card{ background: var(--card); backdrop-filter: blur(8px); border:1px solid var(--stroke); border-radius:20px; padding:18px; box-shadow: var(--shadow); }

    /* Layout */
    .grid{ display:grid; gap:16px; grid-template-columns: 1fr; }
    @media(min-width:960px){ .grid{ grid-template-columns: 1.1fr 0.9fr; } }

    /* Buttons */
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    button{ cursor:pointer; border-radius:14px; padding:12px 16px; border:1px solid var(--stroke); background:#fff; color:#7a1143; font-weight:600; box-shadow: 0 2px 8px rgba(236,72,153,0.15); transition: transform .12s ease, box-shadow .12s ease; }
    button.primary{ background: var(--accent); color:#fff; border-color:transparent; }
    button.warn{ background:#fce7f3; color:#7a1143; }
    button.ghost{ background:transparent; border-style:dashed; }
    button:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(236,72,153,0.25); }
    button:active{ transform: translateY(0px); }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    /* Inputs */
    .pill{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:#fff; color:#7a1143; display:inline-flex; gap:8px; align-items:center; }
    input[type=file]{ accent-color: var(--accent); }
    video, canvas{ width:100%; max-height:360px; object-fit:contain; background:#fff; border-radius:14px; border:1px solid var(--stroke); }
    label{ font-size:13px; color:#7a1143; font-weight:600; }
    textarea{ width:100%; min-height:140px; resize:vertical; padding:12px; border-radius:14px; background:#fff; color:var(--fg); border:1px solid var(--stroke); line-height:1.5; }
    .hint{ font-size:12px; color:#a1a1aa; }

    /* Steps */
    .steps{ display:grid; grid-template-columns: repeat(3,1fr); gap:10px; margin-top:12px; }
    .step{ background:#fff; border:1px solid var(--stroke); border-radius:14px; padding:10px; text-align:center; }
    .n{ display:inline-grid; place-items:center; width:26px; height:26px; border-radius:50%; background: var(--accent); color:#fff; font-weight:700; margin-bottom:6px; }

    /* Progress bar */
    .barWrap{ margin-top:10px; background:#fde7f2; border-radius:12px; overflow:hidden; height:12px; border:1px solid var(--stroke); }
    .bar{ height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-2)); transition:width .2s ease; }

    /* Drop area */
    .drop{ margin-top:10px; border:2px dashed var(--stroke); border-radius:14px; padding:14px; text-align:center; color:#7a1143; background:#fff; }
    .drop.drag{ background:#fff0; border-color:#ec4899; box-shadow: inset 0 0 0 2px #ec489922; }

    footer{ margin-top:18px; text-align:center; color:#7a1143; }
    footer a{ color:#9d174d; text-decoration:none; font-weight:700; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- HERO -->
    <section class="hero" aria-label="Mini Lens">
      <div class="brand">
        <div style="display:flex; align-items:center; gap:12px;">
          <div class="logo" aria-hidden="true">ML</div>
          <div>
            <div class="title">Mini Lens ‚Äî PDF + PasseiDireto + ChatGPT</div>
            <div class="subtitle">Foto ‚Üí texto ‚Üí pesquisa com filtros ‚Üí (opcional) abrir ChatGPT j√° com o texto copiado.</div>
          </div>
        </div>
        <div class="row" style="gap:8px;">
          <button id="btnClear" class="ghost" title="Limpar tudo">üßπ Limpar</button>
          <button id="btnStop" class="ghost" title="Fechar c√¢mera">üõë Fechar c√¢mera</button>
          <button id="btnHelp" class="warn" title="Dicas r√°pidas">‚ùî Dicas</button>
        </div>
      </div>
    </section>

    <!-- Toast & Flash -->
    <div id="toast" style="position:fixed; left:50%; top:16px; transform:translateX(-50%) translateY(-20px); opacity:0; background:#0f172a; color:#fff; padding:10px 14px; border-radius:999px; font-weight:600; box-shadow:0 8px 24px rgba(0,0,0,.25); transition:opacity .25s ease, transform .25s ease; z-index:9999; pointer-events:none;">Foto capturada</div>
    <div id="flash" style="position:fixed; inset:0; background:#fff; opacity:0; pointer-events:none; transition:opacity .15s ease; z-index:9998;"></div>

    <div style="height:14px"></div>

    <div class="grid">
      <!-- Coluna Esquerda: C√¢mera/OCR -->
      <div class="card" aria-label="Captura e OCR">
        <div class="row">
          <button id="btnCam" class="primary">üì∑ Abrir c√¢mera</button>
          <input id="file" type="file" accept="image/*" aria-label="Selecionar imagem" />
          <span class="pill" id="status" role="status" aria-live="polite">Pronto</span>
        </div>
        <div style="margin-top:10px;">
          <video id="video" playsinline aria-label="Pr√©via da c√¢mera"></video>
          <canvas id="canvas" style="display:none;"></canvas>
        </div>
        <div class="row" style="margin-top:10px;">
          <button id="btnTirar">üì∏ Tirar foto (Espa√ßo)</button>
          <button id="btnOCR" class="primary">ü™Ñ Rodar OCR (O)</button>
        </div>
        <div class="drop" id="drop">Arraste e solte uma imagem aqui ou pressione Ctrl+V para colar</div>
        <div class="barWrap" aria-label="Progresso do OCR"><div id="bar" class="bar"></div></div>
        <div class="steps">
          <div class="step"><div class="n">1</div><div>Abra a c√¢mera / selecione / arraste / cole</div></div>
          <div class="step"><div class="n">2</div><div>Clique em <b>Rodar OCR</b> para extrair o texto</div></div>
          <div class="step"><div class="n">3</div><div>Pesquise no Google ou abra o ChatGPT</div></div>
        </div>
      </div>

      <!-- Coluna Direita: Texto/Busca/ChatGPT -->
      <div class="card" aria-label="Pesquisa e ChatGPT">
        <label for="texto">Texto reconhecido (edite se quiser)</label>
        <textarea id="texto" placeholder="O OCR aparece aqui..."></textarea>

        <div class="row">
          <button id="btnGoogle" class="primary">üîé Google (PasseiDireto/PDF) (G)</button>
          <button id="btnGoogleGeral">üåê Google (Geral)</button>
        </div>

        <div class="row" style="margin-top:8px;">
          <button id="btnCopyChat" class="warn" title="Copia o texto e abre o ChatGPT">ü§ñ Copiar + Abrir ChatGPT (C)</button>
          <button id="btnCombo" title="Abre Google (preferidos) e depois ChatGPT com o texto copiado">‚ö° Combo: Google + ChatGPT</button>
        </div>

        <details style="margin-top:10px;">
          <summary style="cursor:pointer;">‚öôÔ∏è Prefer√™ncias (salvas neste navegador)</summary>
          <div class="row" style="margin-top:8px; align-items:flex-start;">
            <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" id="prefAutoOCR"> Rodar OCR automaticamente ap√≥s capturar</label>
            <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" id="prefAutoCopy"> Copiar texto para √°rea de transfer√™ncia ap√≥s OCR</label>
            <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" id="prefHaptics" checked> Vibra√ß√£o ao tirar foto</label>
          </div>
        </details>

        <div class="hint" style="margin-top:8px;">Dica: j√° logado no ChatGPT? Ao abrir a nova aba √© s√≥ colar e enviar.</div>

        <div style="margin-top:12px;">
          <label>Fallback IA (opcional) ‚Äî URL do seu endpoint</label>
          <input id="askUrl" style="width:100%; padding:10px; border-radius:12px; border:1px solid var(--stroke); background:#fff; color:#var(--fg);" placeholder="https://seu-dominio.workers.dev/api/ask" />
          <button id="btnAsk" style="margin-top:8px;">Perguntar √† IA (Resposta ‚Üí Depois C√°lculo)</button>
        </div>

        <div style="margin-top:10px;">
          <label>Resposta da IA</label>
          <textarea id="ia" placeholder="A resposta da IA aparecer√° aqui" readonly></textarea>
        </div>
      </div>
    </div>

    <footer>
      <div>Feito por <b>Leticia Francine Moraes</b></div>
      <div>Instagram: <a href="https://www.instagram.com/le__stars?igsh=dGc3OTE1M2pqNnpk" target="_blank" rel="noopener">@le__stars</a></div>
    </footer>
  </div>

  <script>
    // ===== Utilidades de UI =====
    const toastEl = document.getElementById('toast');
    const flashEl = document.getElementById('flash');
    function setStatus(msg){ document.getElementById('status').textContent = msg; }
    function toast(msg){
      toastEl.textContent = msg; toastEl.style.opacity = '1'; toastEl.style.transform = 'translateX(-50%) translateY(0)';
      clearTimeout(toastEl._t); toastEl._t = setTimeout(()=>{ toastEl.style.opacity = '0'; toastEl.style.transform = 'translateX(-50%) translateY(-20px)'; }, 1400);
    }
    function flash(){ flashEl.style.opacity = '0.6'; setTimeout(()=>{ flashEl.style.opacity = '0'; }, 120); }

    // ===== Elementos =====
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const file = document.getElementById('file');
    const btnCam = document.getElementById('btnCam');
    const btnTirar = document.getElementById('btnTirar');
    const btnOCR = document.getElementById('btnOCR');
    const btnGoogle = document.getElementById('btnGoogle');
    const btnGoogleGeral = document.getElementById('btnGoogleGeral');
    const btnCopyChat = document.getElementById('btnCopyChat');
    const btnCombo = document.getElementById('btnCombo');
    const btnAsk = document.getElementById('btnAsk');
    const btnClear = document.getElementById('btnClear');
    const btnStop = document.getElementById('btnStop');
    const btnHelp = document.getElementById('btnHelp');
    const bar = document.getElementById('bar');
    const texto = document.getElementById('texto');
    const ia = document.getElementById('ia');
    const askUrl = document.getElementById('askUrl');
    const drop = document.getElementById('drop');

    // ===== Prefer√™ncias (localStorage) =====
    const prefAutoOCR = document.getElementById('prefAutoOCR');
    const prefAutoCopy = document.getElementById('prefAutoCopy');
    const prefHaptics = document.getElementById('prefHaptics');

    function loadPrefs(){
      try{
        prefAutoOCR.checked = localStorage.getItem('ml_autoocr') === '1';
        prefAutoCopy.checked = localStorage.getItem('ml_autocopy') === '1';
        prefHaptics.checked = localStorage.getItem('ml_haptics') !== '0';
      }catch(_){ }
    }
    function savePrefs(){
      try{
        localStorage.setItem('ml_autoocr', prefAutoOCR.checked ? '1' : '0');
        localStorage.setItem('ml_autocopy', prefAutoCopy.checked ? '1' : '0');
        localStorage.setItem('ml_haptics', prefHaptics.checked ? '1' : '0');
      }catch(_){ }
    }
    [prefAutoOCR, prefAutoCopy, prefHaptics].forEach(el => el.addEventListener('change', savePrefs));
    loadPrefs();

    let stream = null;

    // ===== C√¢mera =====
    async function openCamera(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
        video.srcObject = stream; await video.play();
        setStatus('C√¢mera aberta');
      }catch(err){
        alert('N√£o consegui abrir a c√¢mera. Voc√™ pode usar o bot√£o de arquivo.');
        setStatus('Sem c√¢mera');
      }
    }

    function stopCamera(){
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; setStatus('C√¢mera fechada'); }
      video.srcObject = null;
    }

    function snap(){
      if(!video.videoWidth){ alert('Abra a c√¢mera antes.'); return; }
      const w = video.videoWidth, h = video.videoHeight;
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      canvas.toBlob(blob => {
        const f = new File([blob], 'captura.jpg', { type: 'image/jpeg' });
        const dt = new DataTransfer(); dt.items.add(f); file.files = dt.files;
        setStatus('Foto capturada');
        try { if(prefHaptics.checked && navigator.vibrate) navigator.vibrate(60); } catch(_){ }
        flash(); toast('‚úì Foto capturada');
        if(prefAutoOCR.checked) runOCR();
      }, 'image/jpeg', 0.92);
    }

    // ===== Entrada por arquivo/arrastar/colar =====
    function setFileFromBlob(blob){
      const f = new File([blob], 'imagem.jpg', { type: 'image/jpeg' });
      const dt = new DataTransfer(); dt.items.add(f); file.files = dt.files;
    }

    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
    drop.addEventListener('drop', e=>{
      e.preventDefault(); drop.classList.remove('drag');
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(f) { file.files = e.dataTransfer.files; setStatus('Imagem selecionada'); if(prefAutoOCR.checked) runOCR(); }
    });
    window.addEventListener('paste', e=>{
      const item = [...(e.clipboardData?.items||[])].find(i=> i.type.startsWith('image/'));
      if(item){ const blob = item.getAsFile(); setFileFromBlob(blob); setStatus('Imagem colada'); if(prefAutoOCR.checked) runOCR(); }
    });

    btnCam.onclick = openCamera;
    btnStop.onclick = stopCamera;
    btnTirar.onclick = snap;

    // ===== OCR otimizado (downscale + contraste) =====
    function updateBar(p){ bar.style.width = Math.max(0, Math.min(100, Math.round(p*100))) + '%'; }

    async function preprocessToCanvas(fileOrBlob){
      const img = await createImageBitmap(fileOrBlob);
      const maxW = 1600; // reduzir para acelerar OCR
      const scale = Math.min(1, maxW / img.width);
      const w = Math.round(img.width * scale), h = Math.round(img.height * scale);
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      // realce simples de contraste + grayscale
      const data = ctx.getImageData(0,0,w,h);
      const px = data.data; // RGBA
      let c = 1.2, o = 20; // contraste e offset
      for(let i=0;i<px.length;i+=4){
        let r=px[i], g=px[i+1], b=px[i+2];
        let gray = (r*0.299 + g*0.587 + b*0.114);
        gray = gray*c + o; // contraste b√°sico
        gray = Math.max(0, Math.min(255, gray));
        px[i]=px[i+1]=px[i+2]=gray;
      }
      ctx.putImageData(data,0,0);
      return canvas;
    }

    async function runOCR(){
      const f = file.files[0];
      if(!f){ alert('Escolha uma imagem ou use a c√¢mera.'); return; }
      setStatus('Lendo texto‚Ä¶'); updateBar(0);
      try{
        const pre = await preprocessToCanvas(f);
        const blob = await new Promise(res=> pre.toBlob(res,'image/png',0.95));
        const result = await Tesseract.recognize(blob, 'por+eng', {
          logger: m => { if(m.status === 'recognizing text'){ updateBar(m.progress); setStatus('OCR: ' + Math.round(m.progress*100) + '%'); } }
        });
        let t = result.data && result.data.text ? result.data.text : '';
        t = t.replace(/[\n\r\t]+/g,' ').replace(/\s{2,}/g,' ').trim();
        texto.value = t; updateBar(1); setStatus('OCR conclu√≠do');
        if(prefAutoCopy.checked && t){ try{ await navigator.clipboard.writeText(t); toast('üìã Texto copiado'); }catch(_){ }}
      }catch(e){ console.error(e); updateBar(0); setStatus('Falha no OCR'); alert('Falha no OCR. Tente reenquadrar a quest√£o.'); }
    }

    btnOCR.onclick = runOCR;

    // ===== Busca / ChatGPT =====
    function makeQuery(base){
      const q = (texto.value || '').trim();
      if(!q){ alert('Sem texto para pesquisar.'); return null; }
      return base + encodeURIComponent(q.substring(0, 250));
    }
    function searchPreferidos(){ const base = makeQuery('https://www.google.com/search?q='); if(!base) return; const filtros = ' +(site:passeidireto.com OR filetype:pdf)'; window.open(base + encodeURIComponent(filtros), '_blank'); }
    function searchGeral(){ const base = makeQuery('https://www.google.com/search?q='); if(!base) return; window.open(base, '_blank'); }
    async function copyAndOpenChat(){ const q = (texto.value || '').trim(); if(!q){ alert('Sem texto para copiar.'); return; } try { await navigator.clipboard.writeText(q); toast('üìã Copiado'); } catch(_){} window.open('https://chat.openai.com', '_blank'); }
    function combo(){ searchPreferidos(); setTimeout(copyAndOpenChat, 600); }

    btnGoogle.onclick = searchPreferidos;
    btnGoogleGeral.onclick = searchGeral;
    btnCopyChat.onclick = copyAndOpenChat;
    btnCombo.onclick = combo;

    async function askAI(){
      const url = (askUrl && askUrl.value ? askUrl.value : '').trim();
      if(!url){ alert('Informe a URL do seu endpoint /api/ask'); return; }
      const q = (texto.value || '').trim();
      if(!q){ alert('Sem texto para enviar √† IA.'); return; }
      setStatus('Perguntando √† IA‚Ä¶');
      try{
        const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ question: q, mode: 'resposta-depois-calculo' }) });
        const data = await r.json();
        ia.value = data.answer ? data.answer : JSON.stringify(data);
        setStatus('IA respondeu');
      }catch(e){ console.error(e); setStatus('Falha na IA'); alert('N√£o consegui falar com o endpoint /api/ask.'); }
    }
    btnAsk.onclick = askAI;

    // ===== Limpar / Ajuda =====
    function clearAll(){ texto.value=''; ia.value=''; file.value=''; updateBar(0); toast('Limpo'); }
    btnClear.onclick = clearAll;
    btnHelp.onclick = ()=>{
      alert('Dicas r√°pidas:\n\n‚Ä¢ Enquadre somente o enunciado, evite sombras.\n‚Ä¢ Use luz ambiente e mantenha a c√¢mera est√°vel.\n‚Ä¢ Se o OCR errar, edite o texto antes de pesquisar.\n‚Ä¢ Ative as Prefer√™ncias para automatizar etapas.\n‚Ä¢ Atalhos: Espa√ßo = Tirar foto, O = OCR, G = Google, C = ChatGPT.');
    };

    // ===== Atalhos de teclado =====
    window.addEventListener('keydown', (e)=>{
      if(e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return; // n√£o conflitar com digita√ß√£o
      if(e.code === 'Space'){ e.preventDefault(); snap(); }
      if(e.key.toLowerCase() === 'o') runOCR();
      if(e.key.toLowerCase() === 'g') searchPreferidos();
      if(e.key.toLowerCase() === 'c') copyAndOpenChat();
    });
  </script>
</body>
</html>
